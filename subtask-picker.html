<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Subtasks</title>
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css" />
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
  </head>
  <body style="margin: 16px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">

    <h3 style="margin-top: 0;">Linked Subtasks</h3>

    <ul id="subtask-list" style="list-style: none; padding-left: 0; margin-bottom: 16px;"></ul>

    <div style="display: flex; gap: 8px;">
      <input
        type="url"
        id="subtask-url"
        class="mod-input"
        placeholder="Paste Trello card URL"
        style="flex-grow: 1; padding: 6px 8px;"
      />
      <button class="mod-primary" onclick="addSubtask()" style="padding: 6px 12px;">
        Add
      </button>
    </div>

    <script>
      const t = TrelloPowerUp.iframe();
      const list = document.getElementById('subtask-list');

      async function fetchCardTitle(url) {
        try {
          const shortLink = extractShortLink(url);
          const res = await fetch(`https://trello.com/1/cards/${shortLink}`);
          const data = await res.json();
          return data.name || `Card ${shortLink}`;
        } catch {
          return `Card ${extractShortLink(url)}`;
        }
      }

      function extractShortLink(url) {
        const match = url.match(/trello\.com\/c\/([a-zA-Z0-9]+)/);
        return match ? match[1] : '';
      }

      async function renderSubtasks(urls) {
        list.innerHTML = '';
        if (!urls.length) {
          list.innerHTML = `<li style="color: #888;">No subtasks yet.</li>`;
          return;
        }

        for (let i = 0; i < urls.length; i++) {
          const url = urls[i];
          const title = await fetchCardTitle(url);

          const li = document.createElement('li');
          li.style = 'display: flex; align-items: center; margin-bottom: 8px; gap: 8px;';

          const link = document.createElement('a');
          link.href = url;
          link.target = '_blank';
          link.textContent = title;
          link.style = 'color: #0079bf; text-decoration: none; font-weight: 500;';
          link.onmouseover = () => link.style.textDecoration = 'underline';
          link.onmouseout = () => link.style.textDecoration = 'none';

          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'âœ•';
          removeBtn.title = 'Remove';
          removeBtn.style = 'border: none; background: none; color: #888; cursor: pointer;';
          removeBtn.onclick = () => removeSubtask(i);

          li.appendChild(link);
          li.appendChild(removeBtn);
          list.appendChild(li);
        }
      }

      function addSubtask() {
        const input = document.getElementById('subtask-url');
        const url = input.value.trim();
        if (!url) return;

        t.get('card', 'shared', 'subtasks', [])
          .then(subtasks => {
            if (!subtasks.includes(url)) {
              subtasks.push(url);
            }
            return t.set('card', 'shared', 'subtasks', subtasks);
          })
          .then(() => {
            input.value = '';
            return t.get('card', 'shared', 'subtasks', []);
          })
          .then(renderSubtasks);
      }

      function removeSubtask(index) {
        t.get('card', 'shared', 'subtasks', [])
          .then(subtasks => {
            subtasks.splice(index, 1);
            return t.set('card', 'shared', 'subtasks', subtasks);
          })
          .then(() => t.get('card', 'shared', 'subtasks', []))
          .then(renderSubtasks);
      }

      t.get('card', 'shared', 'subtasks', []).then(renderSubtasks);
    </script>
  </body>
</html>
